<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Find Case by ID</title>
  <!-- Papa Parse for robust CSV parsing (handles quotes/commas/newlines) -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    :root { --bg:#3134cf; --fg:#ffffff; --accent:#ffffff; }
    body {
        margin: 0; min-height: 100vh; display: grid; place-items: center;
        background: radial-gradient(80vw 80vh at 50% 40%, #000000, var(--bg));
        color: var(--fg); font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, sans-serif;
    }
    .wrap { width: min(700px, 90vw); }
    header { display: flex; align-items: center; gap: .75rem; margin-bottom: 1.25rem; }
    header a { color: var(--muted); text-decoration: none; font-size: .95rem; }
    header a:hover { text-decoration: underline; }
    .panel {
      background: #000;; border: 1px solid rgb(0, 0, 0);
      border-radius: 20px; padding: 1.25rem; box-shadow: 0 18px 45px rgba(133, 133, 216, 0.35);
    }
    h1 { margin: .25rem 0 1rem; font-size: clamp(1.4rem, 2.5vw, 2rem); }
    .grid { display: grid; gap: 1rem; grid-template-columns: 1fr auto; align-items: end; }
    label { font-size: .95rem; color: var(--muted); display: block; margin-bottom: .35rem; }
    input[type="text"] {
      width: 50%; padding: .85rem 1rem; border-radius: 12px; border: 1px solid rgb(11, 0, 0);
      background: #f6f6f7; color: #000000; outline: none;
    }
    .btn {
      padding: .9rem 1.1rem; border-radius: 12px; border: 1px solid rgba(255,255,255,.08);
      background:#3134cf; color: #faf8f8; font-weight: 700;
      cursor: pointer;
    }
    .meta { margin-top: .5rem; color: var(--muted); font-size: .9rem; }
    .result {
      margin-top: 1.25rem; padding: 1rem; border-radius: 16px; background: #06277c; border: 1px solid rgba(174, 17, 17, 0.06);
    }
    .narrative {
      white-space: pre-wrap; line-height: 1.6; font-size: 1.02rem;
    }
    .notfound { color: #973f21; }
    .ok { color: #86efac; }
    .small { font-size: .88rem; color: var(--muted); }
    .row { display: flex; gap: .75rem; align-items: center; }
    .pill { padding: .2rem .55rem; border-radius: 999px; background: rgba(34,211,238,.12); color: #000000; font-size: .78rem; border: 1px solid rgba(34,211,238,.3); }
    footer { margin-top: 1rem; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <a href="SplashScreen.html">← Back</a>
      <span class="pill">CSV-backed</span>
    </header>

    <section class="panel">
      <h1>Look up a Case by ID</h1>
      <div class="grid">
        <div>
          <label for="caseId">Enter Case ID</label>
          <input id="caseId" type="text" placeholder="e.g., SGHHR" />
          <div class="meta small">Exact match on the <code>case_id</code> column (case-insensitive, trims spaces).</div>
        </div>
        <div>
          <button class="btn" id="searchBtn">Find Narrative</button>
        </div>
      </div>

      <div class="meta" id="status">Loading cases…</div>

      <div class="result" id="result" hidden>
        <div class="row">
          <strong>Case:</strong><span id="foundId"></span>
        </div>
        <hr style="border: none; border-top: 1px solid rgba(255,255,255,.08); margin: .75rem 0;" />
        <div class="narrative" id="narrative"></div>
      </div>
    </section>

    <footer class="small">
      Expected CSV columns: <code>case_id</code>, <code>narrative</code>. Extra columns are ignored.
    </footer>
  </div>

  <script>
    // Holds rows keyed by normalized case_id
    const CASES = new Map();

    // Utility to normalize user input and CSV ids
    const norm = s => (s || '').toString().trim().toLowerCase();

    // Status helpers
    const statusEl = document.getElementById('status');
    const setStatus = (msg, ok=false) => {
      statusEl.textContent = msg;
      statusEl.className = 'meta ' + (ok ? 'ok' : '');
    };

    // Load CSV on page load
    function loadCsv() {
      Papa.parse('verbal_autopsy_cases.csv', {
        header: true,
        download: true,
        skipEmptyLines: true,
        complete: (res) => {
          if (res.errors && res.errors.length) {
            console.warn('CSV parse errors:', res.errors);
          }
          const rows = res.data || [];
          let added = 0;
          for (const row of rows) {
            const id = norm(row.case_id);
            if (!id) continue;
            CASES.set(id, row);
            added++;
          }
          if (added === 0) {
            setStatus('No cases found in CSV. Check headers "case_id" and "narrative".');
          } else {
            setStatus(`Loaded ${added} case${added===1?'':'s'}. Ready.`, true);
          }

          // If there's a caseId in the URL (?id=VA-001), auto-fill & search
          const params = new URLSearchParams(window.location.search);
          const q = params.get('id');
          if (q) {
            document.getElementById('caseId').value = q;
            findCase();
          }
        },
        error: (err) => {
          console.error(err);
          setStatus('Failed to load CSV. Make sure it is named "verbal_autopsy_cases.csv" and sits next to this file.');
        }
      });
    }

    async function findCase() {
      const input = document.getElementById('caseId');
      const id = norm(input.value);
      const resultEl = document.getElementById('result');
      const narrativeEl = document.getElementById('narrative');
      const foundIdEl = document.getElementById('foundId');

      if (!id) {
        setStatus('Please enter a Case ID.');
        resultEl.hidden = true;
        return;
      }

      const row = CASES.get(id);
      if (!row) {
        setStatus(`No case found for ID "${input.value}".`, false);
        resultEl.hidden = true;
        return;
      }

      const narrative = row.narrative || '(No narrative provided)';
      foundIdEl.textContent = row.case_id ?? input.value;
      narrativeEl.textContent = narrative; // preserved as plain text; newlines kept via CSS
      resultEl.hidden = false;
      setStatus('Result shown below.', true);
    }

    document.getElementById('searchBtn').addEventListener('click', findCase);
    document.getElementById('caseId').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') findCase();
    });

    // Kick off CSV loading
    loadCsv();
  </script>
</body>
</html>
